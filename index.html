<!DOCTYPE html>
<html lang="ta">
<head>
<meta charset="UTF-8">
<title>à®¤à®®à®¿à®´à¯ AI Chatbot + Email</title>
<style>
body { font-family: Arial; background:#111; color:#fff; text-align:center; }
#chat { width: 80%; max-width: 600px; margin:20px auto; background:#222; padding:15px; border-radius:10px; }
.msg { margin:10px; padding:10px; border-radius:6px; }
.user { background:#444; text-align:right; }
.bot { background:#2a2a6a; text-align:left; white-space: pre-line; }
.sources { font-size:12px; color:#aaa; margin-top:5px; }
input { padding:8px; border-radius:5px; border:none; }
button { padding:8px 15px; border-radius:5px; border:none; background:#4caf50; color:white; cursor:pointer; }
</style>
</head>
<body>
<h1>ğŸ’¬ à®¤à®®à®¿à®´à¯ AI Chatbot</h1>
<div id="chat"></div>
<input id="q" type="text" placeholder="à®‰à®™à¯à®•à®³à¯ à®•à¯‡à®³à¯à®µà®¿à®¯à¯ˆ à®‡à®™à¯à®•à¯‡ type à®šà¯†à®¯à¯à®¯à®µà¯à®®à¯..." style="width:70%">
<button onclick="ask()">à®•à¯‡à®³à¯</button>

<!-- Hidden Netlify Form -->
<form name="user-questions" netlify netlify-honeypot="bot-field" hidden>
  <input type="text" name="question" id="hiddenQuestion">
</form>

<script>
// âœ… Local variable answers
const localAnswers = {
  "à®µà®£à®•à¯à®•à®®à¯": "à®µà®£à®•à¯à®•à®®à¯! à®à®ªà¯à®ªà®Ÿà®¿ à®‡à®°à¯à®•à¯à®•à®¿à®±à¯€à®°à¯à®•à®³à¯?",
  "à®‰à®©à¯ à®ªà¯†à®¯à®°à¯ à®à®©à¯à®©": "à®à®©à¯ à®ªà¯†à®¯à®°à¯ à®¤à®®à®¿à®´à¯ Cyber Zone AI ğŸ¤–",
  "car": "Car à®à®©à¯à®ªà®¤à¯ à®’à®°à¯ à®µà®¾à®•à®©à®®à¯ ğŸš—"
};

// âœ… Voices load fix
let voices = [];
window.speechSynthesis.onvoiceschanged = () => {
  voices = window.speechSynthesis.getVoices();
};

// âœ… Voice output
function speak(text){
  if('speechSynthesis' in window){
    const utter = new SpeechSynthesisUtterance(text.replace(/<br>/g,' '));
    const tamilVoice = voices.find(v=>v.lang.startsWith('ta')) || voices.find(v=>v.lang.startsWith('en')) || voices[0];
    if(tamilVoice) utter.voice = tamilVoice;
    window.speechSynthesis.speak(utter);
  }
}

// âœ… Silent Email send (via Netlify form)
function sendToEmail(userInput){
  const formData = new FormData();
  formData.append("form-name", "user-questions");
  formData.append("question", userInput);

  fetch("/", {
    method: "POST",
    body: formData
  }).catch((error) => console.error("Form submit error:", error));
}

// âœ… Main chatbot
async function ask(){
  const q = document.getElementById("q").value.trim();
  if(!q) return;
  addMsg("user", q);
  document.getElementById("q").value = "";

  let finalAnswer = "";
  let sources = [];
  let moreLinks = [];

  // 1ï¸âƒ£ Local variable check
  if(localAnswers[q]){
    finalAnswer = localAnswers[q];
    sources.push("Local Variable");
    addMsg("bot", finalAnswer + sourceText());
    speak(finalAnswer);
    return;
  } else {
    // Not found in local â†’ send to Netlify form (silent)
    sendToEmail(q);
  }

  // 2ï¸âƒ£ Wikipedia
  try{
    let wiki = await fetch(`https://ta.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(q)}`);
    if(wiki.ok){
      let j = await wiki.json();
      if(j.extract){
        finalAnswer += "ğŸ“– Wikipedia: " + j.extract + "\n\n";
        sources.push("Wikipedia");
        moreLinks.push(j.content_urls?.desktop?.page);
      }
    }
  }catch(e){console.error(e);}

  // 3ï¸âƒ£ DuckDuckGo
  try{
    let ddg = await fetch(`https://api.duckduckgo.com/?q=${encodeURIComponent(q)}&format=json&no_redirect=1&no_html=1`);
    if(ddg.ok){
      let j = await ddg.json();
      if(j.AbstractText){
        finalAnswer += "ğŸ” DuckDuckGo: " + j.AbstractText + "\n\n";
        sources.push("DuckDuckGo");
        if(j.AbstractURL) moreLinks.push(j.AbstractURL);
      }
    }
  }catch(e){console.error(e);}

  // 4ï¸âƒ£ OpenLibrary
  try{
    let ol = await fetch(`https://openlibrary.org/search.json?q=${encodeURIComponent(q)}`);
    if(ol.ok){
      let j = await ol.json();
      if(j.docs && j.docs.length>0){
        finalAnswer += "ğŸ“š OpenLibrary: " + j.docs[0].title + "\n\n";
        sources.push("OpenLibrary");
        moreLinks.push("https://openlibrary.org" + j.docs[0].key);
      }
    }
  }catch(e){console.error(e);}

  // 5ï¸âƒ£ Fallback
  if(!finalAnswer) finalAnswer = "à®®à®©à¯à®©à®¿à®•à¯à®•à®µà¯à®®à¯, à®ªà®¤à®¿à®²à¯ à®•à®¿à®Ÿà¯ˆà®•à¯à®•à®µà®¿à®²à¯à®²à¯ˆ.";

  addMsg("bot", finalAnswer + sourceText());
  speak(finalAnswer.replace(/ğŸ“–|ğŸ”|ğŸ“š/g,""));

  function sourceText(){
    return sources.length ? `<div class='sources'>à®®à¯‚à®²à®®à¯: ${sources.join(", ")}<br>à®®à¯‡à®²à¯à®®à¯ à®ªà®¾à®°à¯à®•à¯à®•: ${moreLinks.map(l=>`<a href="${l}" target="_blank">${l}</a>`).join(", ")}</div>` : "";
  }
}

// âœ… Chat UI
function addMsg(type, text){
  let div = document.createElement("div");
  div.className = "msg " + type;
  div.innerHTML = text;
  document.getElementById("chat").appendChild(div);
  document.getElementById("chat").scrollTop = document.getElementById("chat").scrollHeight;
}
</script>
</body>
</html>
